#!/bin/bash
#
#===========================================================================

set -euo pipefail
exec 2>&1

#---------------------------------

function _ctools_start_usage
{
#TODO
}

#---------------------------------
# Main

CTOOLS_PHASE="start"

. ctools-common

while getopts vc:r:d:h _opt;	do
	case $_opt in
		v) sf_verbose_level=`expr $sf_verbose_level + 1` ;;
    c) CTOOLS_CFGDIR="$OPTARG" ;;
    r) CTOOLS_ROLE="$OPTARG" ;;
    d) CTOOLS_TMPDIR="$OPTARG" ;;
		h) _ctools_start_usage ; exit 0 ;;
		?) _ctools_usage ; exit 1 ;;
	esac
done

[ -d $CTOOLS_TMPDIR ] || sf_fatal "$CTOOLS_TMPDIR: Tmp dir not found"
cd $CTOOLS_TMPDIR

sf_debug "Environment file: $CTOOLS_ENVFILE"

#----

_ctools_source_cfg_script "env" "role/$CTOOLS_ROLE/env"

#----
# Load environment generated by init

if [ ! -f "$CTOOLS_ENVFILE" ]; then
  sf_trace "Init env file not found"
  if [ -n "$CTOOLS_ENSURE_INIT"]; then
    sf_msg "Init env file not found - running init"
    init_container
  fi
fi

if [ -f "$CTOOLS_ENVFILE" ]; then
  sf_trace "Loading init environment"
  source "$CTOOLS_ENVFILE"
fi

if [ "$sf_verbose_level" -ge 2 ]; then
  sf_msg "Environment after loading init env :"
  env
fi

# Start

if [ -n "$CTOOLS_ROLE" ]; then
  _ctools_source_cfg_script "role/$CTOOLS_ROLE/start"
else
  path="`_ctools_cfg_script_path start`"
  if [ -f "$file"]; then
    _ctools_source_cfg_script "start"
  else
    echo "No start script - Running an endless loop"
    while true ; do sleep 3600 ; done
  fi
fi
